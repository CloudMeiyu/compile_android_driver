name: Android Kernel Driver Builder

on:
  workflow_dispatch:
    inputs:
      android_version:
        description: 'Android Version (Kernel) (e.g., 14)'
        required: true
      kernel_version:
        description: 'Kernel Version (e.g., 6.1)'
        required: true
      driver_name:
        description: 'Driver Module Name (e.g., mydriver.ko)'
        required: true
      target_arch:
        description: 'Target Architecture (aarch64, x86_64, etc.)'
        required: true
        default: 'aarch64'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4.2.2
        
      - name: Prepare kerneldriver directory
        run: |
          mkdir kerneldriver
          mv ./code/*.h ./code/*.c ./code/Makefile kerneldriver/

      - name: Cache Android Kernel source
        uses: actions/cache@v4
        id: kernel-cache
        with:
          path: |
            android-kernel/.repo
            android-kernel/common
            android-kernel/build
            android-kernel/tools
          key: ${{ runner.os }}-android-kernel-${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}-v2
          restore-keys: |
            ${{ runner.os }}-android-kernel-${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}-
            ${{ runner.os }}-android-kernel-

      - name: Cache build tools
        uses: actions/cache@v4
        id: build-tools-cache
        with:
          path: |
            ~/.cache/bazel
            /usr/local/bin/repo
          key: ${{ runner.os }}-build-tools-v2
          restore-keys: |
            ${{ runner.os }}-build-tools-

      - name: Install repo tool
        run: |
          sudo curl -L https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
          sudo chmod a+x /usr/local/bin/repo

      - name: Set up Android Kernel source
        run: |
          mkdir -p android-kernel && cd android-kernel
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}
          repo sync -j$(nproc) -c --no-tags --optimized-fetch --force-sync --no-clone-bundle

      - name: Copy kerneldriver
        run: |
          cd android-kernel
          cp -r ../kerneldriver common/drivers

      - name: Modify Makefile
        run: |
          cd android-kernel
          echo "obj-y += kerneldriver/" >> common/drivers/Makefile

      - name: Add module to GKI modules list
        if: ${{ github.event.inputs.android_version > 13 }}
        run: |
          cd android-kernel
          MODULE_NAME="drivers/kerneldriver/${{ github.event.inputs.driver_name }}"
          
          awk -i inplace -v module="$MODULE_NAME" '
            BEGIN { added=0 }
            /_COMMON_GKI_MODULES_LIST = \[/ { in_list=1 }
            in_list && /\]/ {
              if (!added) {
                print "    \"" module "\","
                added=1
              }
              in_list=0
            }
            in_list && !added {
              if (module < $0) {
                print "    \"" module "\","
                added=1
              }
            }
            { print }
          ' common/modules.bzl
          
      - name: Prepare module list for legacy builds
        if: ${{ github.event.inputs.android_version <= 13 }}
        run: |
          cd android-kernel
          echo "drivers/kerneldriver/${{ github.event.inputs.driver_name }}" >> common/android/gki_aarch64_modules
      - name: Increase stack frame size limit
        run: |
          cd android-kernel
          find . -type f -name "Makefile*" -exec sed -i 's/-Wframe-larger-than=[0-9]*/-Wframe-larger-than=4096/g' {} +
          grep -q "FRAME_WARN" common/Makefile || echo 'KBUILD_CFLAGS += -Wframe-larger-than=4096' >> common/Makefile

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential flex bison libssl-dev libelf-dev bc python-is-python3
      - name: Fix missing kprobe symbols for Android 13
        if: ${{ github.event.inputs.android_version == 13 }}
        run: |
          cd android-kernel
          for symbol in register_kprobe unregister_kprobe; do
            grep -q "$symbol" common/android/abi_gki_${{ github.event.inputs.target_arch }} || \
            echo "$symbol" >> common/android/abi_gki_${{ github.event.inputs.target_arch }}
          done
          sed -i '/EXPORT_SYMBOL(unregister_kprobe);/a EXPORT_SYMBOL(register_kprobe);' common/kernel/kprobes.c
          
      - name: Build kernel module
        run: |
          cd android-kernel
          if [ ${{ github.event.inputs.android_version }} -le 13 ]; then
            BUILD_CONFIG=common/build.config.gki.${{ github.event.inputs.target_arch }} LTO=thin build/build.sh -j32
            OUTPUT_PATH="out/android${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/dist"
          else
            echo "Using Bazel build system for Android ${{ github.event.inputs.android_version }}"
            tools/bazel run //common:kernel_${{ github.event.inputs.target_arch }}_dist
            OUTPUT_PATH="out/kernel_${{ github.event.inputs.target_arch }}"
          fi
          echo "OUTPUT_PATH=$OUTPUT_PATH" >> $GITHUB_ENV
        continue-on-error: true
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.6.2
        with:
          name: kernel-driver-${{ github.event.inputs.target_arch }}
          path: |
            android-kernel/${{ env.OUTPUT_PATH }}
            
      # 准备同步到 Gitee
      - name: Prepare Gitee sync
        run: |
          # 创建用于同步的目录结构
          mkdir -p gitee-sync/${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/${{ github.event.inputs.target_arch }}
          # 复制构建产物
          cp -r android-kernel/${{ env.OUTPUT_PATH }}/* gitee-sync/${{ github.event.inputs.android_version }}-${{ github.event.inputs.kernel_version }}/${{ github.event.inputs.target_arch }}/
          # 添加版本信息文件
          echo "Android Version: ${{ github.event.inputs.android_version }}" > gitee-sync/VERSION_INFO
          echo "Kernel Version: ${{ github.event.inputs.kernel_version }}" >> gitee-sync/VERSION_INFO
          echo "Driver Name: ${{ github.event.inputs.driver_name }}" >> gitee-sync/VERSION_INFO
          echo "Target Arch: ${{ github.event.inputs.target_arch }}" >> gitee-sync/VERSION_INFO
          echo "Build Date: $(date)" >> gitee-sync/VERSION_INFO
          
      # 配置 Git 安全目录
      - name: Fix Git Safe Directory
        run: git config --global --add safe.directory /github/workspace

      # 同步到 Gitee
      - name: Sync to Gitee
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_RSA_PRIVATE_KEY }}
        run: |
          # 设置 SSH 配置
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/gitee_key
          chmod 600 ~/.ssh/gitee_key
          
          # 添加主机到已知主机列表
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          ssh-keyscan -H gitee.com >> ~/.ssh/known_hosts
          
          # 配置 Git 安全目录
          git config --global --add safe.directory /github/workspace
          
          # 配置 Git 用户信息
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 初始化 Git 仓库并推送到 Gitee
          cd gitee-sync
          git init
          git add .
          git commit -m "Auto-sync from GitHub Actions - $(date)"
          
          # 添加 Gitee 远程仓库
          git remote add gitee git@gitee.com:a34664327/compile_android_driver.git
          
          # 强制推送到 Gitee
          GIT_SSH_COMMAND="ssh -i ~/.ssh/gitee_key" git push -f gitee main:main
